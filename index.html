<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Poker 2025/2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <!-- React + Babel (para un √∫nico archivo editable desde m√≥vil) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0f1116;--panel:#151a23;--panel2:#10141c;--text:#e8ecf3;--muted:#9aa3b2;--accent:#2fd27a;--danger:#ff5151;--chip:#23283a;--line:#222839}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;line-height:1.35}
    header{position:sticky;top:0;background:linear-gradient(180deg,#0f1116,rgba(15,17,22,.85));backdrop-filter:saturate(1.2) blur(8px);z-index:10}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:0;display:flex;align-items:center;gap:10px}
    .tag{background:var(--chip);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    nav{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:12px}
    nav a{display:block;text-align:center;padding:10px 8px;background:var(--panel);border-radius:12px;color:var(--text);text-decoration:none;font-weight:600;border:1px solid var(--line)}
    nav a:hover{background:var(--panel2)}
    section{padding:18px 16px}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 140px}
    input,select,button,textarea{width:100%;background:#0f1320;border:1px solid #2a3150;color:var(--text);padding:10px;border-radius:10px;font:inherit}
    button{cursor:pointer;background:linear-gradient(180deg,#1d9d63,#178653);border:none}
    button.secondary{background:#242a3f}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #20263a;text-align:left}
    th{color:var(--muted);font-weight:600}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#1a1f30;border:1px solid #27304a;padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}
    .ok{color:var(--accent)} .bad{color:var(--danger)}
    .inline{display:flex;gap:8px;align-items:center}
    .right{margin-left:auto}
    .ghost{opacity:.7}
    .avatar{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #2a3150;background:#0c0e17}
    .mini{font-size:12px;color:var(--muted)}
    footer{padding:30px;color:var(--muted);text-align:center}
    .btn-danger{background:linear-gradient(180deg,#e05252,#c93232)}
    @media (max-width:560px){nav{grid-template-columns:repeat(2,1fr)} th:nth-child(4),td:nth-child(4){display:none}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>
        <span style="font-weight:800">Poker 2025/2026</span>
        <span class="tag">amigos ¬∑ p√∫blico ¬∑ sin login</span>
        <span class="pill right"><span id="statusDot">‚óè</span><span id="statusText">offline</span></span>
      </h1>
      <nav>
        <a href="#jugadores">Jugadores</a>
        <a href="#clasificacion">Clasificaci√≥n</a>
        <a href="#partidas">Resultados por partida</a>
        <a href="#reglas">Reglas</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <section id="jugadores">
      <h2>üë§ Jugadores (hasta 15)</h2>
      <div class="card">
        <div class="row">
          <input id="inpNombre" placeholder="Nombre del jugador">
          <input id="inpAvatar" placeholder="URL avatar (opcional)">
          <button id="btnAddJugador">A√±adir jugador</button>
        </div>
        <div class="mini" style="margin-top:8px">Tip: usa avatar cuadrado 512√ó512</div>
      </div>
      <div class="card">
        <table>
          <thead><tr><th>Jugador</th><th>Puntos</th><th>Balance</th><th>ID</th></tr></thead>
          <tbody id="tbJugadores"></tbody>
        </table>
      </div>
    </section>

    <section id="clasificacion">
      <h2>üèÜ Clasificaci√≥n general</h2>
      <div class="card">
        <table>
          <thead><tr><th>#</th><th>Jugador</th><th>Puntos</th><th>Balance</th></tr></thead>
          <tbody id="tbClasificacion"></tbody>
        </table>
      </div>
    </section>

    <section id="partidas">
      <h2>üÉè Resultados por partida</h2>
      <div class="card">
        <div class="row">
          <input id="inpFecha" type="date">
          <input id="inpBuyIn" type="number" step="1" placeholder="Buy-in (‚Ç¨)">
          <input id="inpNotas" placeholder="Notas (opcional)">
          <button id="btnAddPartida">Nueva partida</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <select id="selPartida"></select>
          <select id="selJugador"></select>
          <input id="inpPosicion" type="number" min="1" step="1" placeholder="Posici√≥n (1=ganador)">
          <input id="inpPuntos" type="number" step="1" placeholder="Puntos">
          <input id="inpPremio" type="number" step="1" placeholder="Premio (‚Ç¨)">
          <button id="btnAddResultado">A√±adir resultado</button>
        </div>
      </div>

      <div class="card">
        <table>
          <thead><tr><th>Fecha</th><th>Jugador</th><th>Posici√≥n</th><th>Puntos</th><th>Premio</th></tr></thead>
          <tbody id="tbResultados"></tbody>
        </table>
      </div>
    </section>

    <section id="reglas">
      <h2>üìú Reglas</h2>
      <div class="card">
        <ul>
          <li>Hasta 15 jugadores. Puntuaci√≥n configurable.</li>
          <li>Buy-in libre. Premios seg√∫n posici√≥n.</li>
          <li>Sin login: pol√≠ticas p√∫blicas en Supabase (solo para grupos de confianza).</li>
          <li>Actualiza en directo (Realtime + broadcast). Si la red bloquea sockets: polling.</li>
        </ul>
        <p class="mini">Edita las claves en el bloque ‚ÄúConfigura tus credenciales‚Äù de este HTML.</p>
      </div>
    </section>
  </main>

  <footer>v1 ‚Ä¢ Supabase Realtime (broadcast + postgres_changes) + Polling</footer>

  <!-- ===================== BACKEND JS (Supabase) ===================== -->
  <script>
  // === Configura tus credenciales (copiar de Project Settings ‚Üí API) ===
  const SUPABASE_URL  = "https://ynqkncnsqfjtcvvyklvy.supabase.co"; // <- pon aqu√≠ tu URL
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlucWtuY25zcWZqdGN2dnlrbHZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgxNDAwMTEsImV4cCI6MjA3MzcxNjAxMX0.YE41Q4eX9UjuocXxF3e2b6lRWNrj7SGyY-LF6REdync"; // <- y aqu√≠ tu anon key (p√∫blica)

  // Cliente Supabase
  const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
  window.client = client; // por si lo necesitas en consola

  // Estado visual
  const statusDot  = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  function setStatus(txt, ok=false){ statusText.textContent=txt; statusDot.style.color = ok? 'var(--accent)' : 'var(--danger)'; }

  // Helpers
  const elJug = document.getElementById('tbJugadores');
  const elCla = document.getElementById('tbClasificacion');
  const elSelJugador = document.getElementById('selJugador');
  const elSelPartida = document.getElementById('selPartida');
  const elRes = document.getElementById('tbResultados');

  function fmtEUR(n){ n=Number(n||0); return n.toLocaleString('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0}); }

  // ---- Renderers (los usa React por debajo) ----
  window.renderJugadores = (rows=[]) => {
    // Tabla
    elJug.innerHTML = rows.map(j => `
      <tr>
        <td class="inline">
          <img class="avatar" src="${j.avatar||''}" onerror="this.style.visibility='hidden'">
          <strong>${j.nombre||'‚Äî'}</strong>
        </td>
        <td>${j.puntos ?? 0}</td>
        <td>${fmtEUR(j.balance)}</td>
        <td class="ghost mini">${j.id}</td>
      </tr>
    `).join('');
    // Select jugadores
    elSelJugador.innerHTML = rows.map(j => `<option value="${j.id}">${j.nombre}</option>`).join('');
    // Notificar a React
    if (window.__setPlayers) {
      const mapped = rows.map(r => ({ id:r.id, name:r.nombre, photo:r.avatar||null, paid: !!r.paid, totalPoints:Number(r.puntos||0), gamesPlayed:0, wins:0 }));
      window.__setPlayers(mapped);
    }
  };

  window.renderClasificacion = (rows=[]) => {
    elCla.innerHTML = rows.map((r,i)=>`
      <tr><td>${i+1}</td><td>${r.nombre}</td><td><strong>${r.puntos ?? 0}</strong></td><td>${fmtEUR(r.balance)}</td></tr>
    `).join('');
    if (window.__setRanking) window.__setRanking(rows);
  };

  window.renderPartidasSelector = (rows=[]) => {
    elSelPartida.innerHTML = rows.map(p => `<option value="${p.id}">${p.fecha} ¬∑ ‚Ç¨${p.buy_in}</option>`).join('');
    if (window.__setGames) window.__setGames(rows);
  };

  window.renderResultados = (rows=[]) => {
    elRes.innerHTML = rows.map(r => `
      <tr>
        <td>${r.fecha || r.partidas?.fecha || ''}</td>
        <td>${r.jugador_nombre || r.jugadores?.nombre || ''}</td>
        <td>${r.posicion ?? ''}</td>
        <td>${r.puntos ?? 0}</td>
        <td>${fmtEUR(r.premio)}</td>
      </tr>
    `).join('');
    if (window.__setResults) window.__setResults(rows);
  };

  // ---- Cargas ----
  async function loadJugadores(){
    const { data, error } = await client.from('jugadores').select('*').order('puntos',{ascending:false});
    if(error){ console.error('jugadores/select',error); return; }
    window.renderJugadores(data||[]);
  }
  async function loadPartidas(){
    const { data, error } = await client.from('partidas').select('*').order('fecha',{ascending:false});
    if(error){ console.error('partidas/select',error); return; }
    window.renderPartidasSelector(data||[]);
  }
  async function loadResultados(){
    // Nota: si no tienes FKs, no habr√° join autom√°tico; rellenamos fecha/nombre luego si es necesario
    const { data, error } = await client.from('resultados').select('*').order('created_at',{ascending:false});
    if(error){ console.error('resultados/select',error); return; }
    // Enriquecer con nombres/fechas si est√°n en cache (cargadas antes)
    const js = (await client.from('jugadores').select('id,nombre')).data || [];
    const ps = (await client.from('partidas').select('id,fecha')).data || [];
    const jmap = Object.fromEntries(js.map(j=>[j.id,j.nombre]));
    const pmap = Object.fromEntries(ps.map(p=>[p.id,p.fecha]));
    const enriched = (data||[]).map(r => ({...r, jugador_nombre: jmap[r.jugador_id] || '', fecha: pmap[r.partida_id] || ''}));
    window.renderResultados(enriched);
  }
  async function loadClasificacion(){
    // Si existe la vista 'clasificacion', √∫sala; si no, calc√∫lala aqu√≠
    const tryView = await client.from('clasificacion').select('*').order('puntos',{ascending:false});
    if (!tryView.error && Array.isArray(tryView.data)) {
      window.renderClasificacion(tryView.data);
      return;
    }
    // Fallback: calcula puntos = jugadores.puntos + sum(resultados.puntos)
    const js = (await client.from('jugadores').select('id,nombre,puntos,balance')).data || [];
    const rs = (await client.from('resultados').select('jugador_id,puntos')).data || [];
    const acc = {};
    rs.forEach(r => { acc[r.jugador_id] = (acc[r.jugador_id]||0) + Number(r.puntos||0); });
    const clasif = js.map(j => ({ id:j.id, nombre:j.nombre, puntos:Number(j.puntos||0) + (acc[j.id]||0), balance:j.balance }))
                     .sort((a,b)=> b.puntos - a.puntos);
    window.renderClasificacion(clasif);
  }

  // ---- Escrituras ----
  async function addJugador(nombre, avatar){
    const { error } = await client.from('jugadores').insert({ nombre, avatar }).select();
    if (error) console.error('jugadores/insert', error);
  }
  async function updateJugador(id, patch){
    const { error } = await client.from('jugadores').update(patch).eq('id', id);
    if (error) console.error('jugadores/update', error);
  }
  async function deleteJugador(id){
    const { error } = await client.from('jugadores').delete().eq('id', id);
    if (error) console.error('jugadores/delete', error);
  }
  async function addPartida(payload){
    const { data, error } = await client.from('partidas').insert(payload).select().single();
    if (error) { console.error('partidas/insert', error); return null; }
    return data;
  }
  async function addResultado(partida_id, jugador_id, posicion, puntos, premio){
    const { error } = await client.from('resultados').insert({ partida_id, jugador_id, posicion, puntos, premio }).select();
    if (error) console.error('resultados/insert', error);
  }

  // ---- Realtime (dos v√≠as): postgres_changes + broadcast ----
  const rt = client.channel('db-changes');
  rt.on('postgres_changes', { event:'*', schema:'public', table:'jugadores'  }, () => refreshAll('[rt] jugadores'));
  rt.on('postgres_changes', { event:'*', schema:'public', table:'partidas'   }, () => refreshAll('[rt] partidas'));
  rt.on('postgres_changes', { event:'*', schema:'public', table:'resultados' }, () => refreshAll('[rt] resultados'));
  rt.subscribe((status)=> console.log('[realtime]', status));

  const broadcast = client.channel('poker-2025-2026');
  broadcast.on('broadcast',{ event:'data-changed' }, () => refreshAll('[broadcast]'));
  broadcast.subscribe((status)=> console.log('[broadcast]', status));
  async function notifyChange(table){
    try{ await broadcast.send({ type:'broadcast', event:'data-changed', payload:{ table } }); }catch(e){}
  }

  // ---- Polling (fallback si la red bloquea sockets) ----
  let POLL_ID=null;
  function startPolling(ms=5000){ if(POLL_ID) clearInterval(POLL_ID); POLL_ID = setInterval(()=> refreshAll('[poll]'), ms); }

  // ---- Refresh maestro ----
  async function refreshAll(tag=''){
    console.log('refreshAll', tag);
    await Promise.all([loadJugadores(), loadPartidas(), loadResultados(), loadClasificacion()]);
    setStatus('online', true);
  }

  // ---- Bootstrap ----
  async function initSupabaseBackend(){
    try{
      setStatus('conectando‚Ä¶');
      await refreshAll('[init]');
      // Si en 10s no vemos eventos realtime, forzamos polling
      setTimeout(()=> startPolling(8000), 10000);
    }catch(e){
      console.error('initSupabaseBackend', e);
      startPolling(8000);
      setStatus('online (polling)', true);
    }
  }
  window.initSupabaseBackend = initSupabaseBackend;
  window.addJugador = async (...a)=>{ await addJugador(...a); await notifyChange('jugadores'); };
  window.updateJugador = async (...a)=>{ await updateJugador(...a); await notifyChange('jugadores'); };
  window.deleteJugador = async (...a)=>{ await deleteJugador(...a); await notifyChange('jugadores'); };
  window.addPartida = async (...a)=>{ const p=await addPartida(...a); await notifyChange('partidas'); return p; };
  window.addResultado = async (...a)=>{ await addResultado(...a); await notifyChange('resultados'); };

  document.addEventListener('DOMContentLoaded', () => initSupabaseBackend());
  </script>

  <!-- ===================== FRONTEND (React) ===================== -->
  <script type="text/babel">
  const { useEffect, useState } = React;

  function App(){
    const [players, setPlayers] = useState([]);
    const [ranking, setRanking] = useState([]);
    const [games, setGames] = useState([]);
    const [results, setResults] = useState([]);

    // Exponer setters para los renderers del backend
    useEffect(()=>{
      window.__setPlayers = setPlayers;
      window.__setRanking = setRanking;
      window.__setGames   = setGames;
      window.__setResults = setResults;
    },[]);

    // Form: a√±adir jugador
    const [newName, setNewName] = useState("");
    const [newAvatar, setNewAvatar] = useState("");
    const canAddPlayer = () => newName.trim() && players.length < 15;

    async function onAddPlayer(){
      if(!canAddPlayer()) return;
      await window.addJugador(newName.trim(), newAvatar.trim() || null);
      setNewName(""); setNewAvatar("");
    }

    // Form: nueva partida
    const [fecha, setFecha] = useState("");
    const [buyIn, setBuyIn] = useState("");
    const [notas, setNotas] = useState("");
    async function onAddPartida(){
      const payload = { fecha: fecha || new Date().toISOString().slice(0,10), buy_in: Number(buyIn||0), notas: notas||null };
      const p = await window.addPartida(payload);
      if (p && document.getElementById('selPartida')) {
        document.getElementById('selPartida').value = p.id;
      }
      setFecha(""); setBuyIn(""); setNotas("");
    }

    // Form: nuevo resultado
    const [posicion, setPosicion] = useState("");
    const [puntos, setPuntos] = useState("");
    const [premio, setPremio] = useState("");
    async function onAddResultado(){
      const partidaId = document.getElementById('selPartida').value;
      const jugadorId = document.getElementById('selJugador').value;
      if(!partidaId || !jugadorId) return;
      await window.addResultado(partidaId, jugadorId, Number(posicion||0), Number(puntos||0), Number(premio||0));
      setPosicion(""); setPuntos(""); setPremio("");
    }

    // Toggle pago (requiere columna paid boolean en jugadores)
    async function togglePaid(id){
      const pj = players.find(p=>p.id===id);
      if(!pj) return;
      await window.updateJugador(id, { paid: !pj.paid });
    }

    return (
      <div>
        {/* Jugadores */}
        <section>
          <div className="row">
            <input placeholder="Nombre del jugador"
              value={newName} onChange={e=>setNewName(e.target.value)}
              onKeyDown={e=> e.key==='Enter' && onAddPlayer()} />
            <input placeholder="URL avatar (opcional)"
              value={newAvatar} onChange={e=>setNewAvatar(e.target.value)}
              onKeyDown={e=> e.key==='Enter' && onAddPlayer()} />
            <button onClick={onAddPlayer} disabled={!canAddPlayer()}>A√±adir jugador</button>
          </div>

          <div className="card" style={{marginTop:12}}>
            <table>
              <thead><tr><th>Jugador</th><th>Puntos</th><th>Balance</th><th>Pago</th></tr></thead>
              <tbody>
              {players.map(j => (
                <tr key={j.id}>
                  <td className="inline">
                    <img className="avatar" src={j.photo||''} onError={(e)=> e.currentTarget.style.visibility='hidden'} />
                    <strong>{j.name}</strong>
                  </td>
                  <td>{j.totalPoints||0}</td>
                  <td>{(new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0})).format(j.balance||0)}</td>
                  <td>
                    <button className={j.paid ? "secondary" : ""} onClick={()=>togglePaid(j.id)}>
                      {j.paid ? 'Pagado' : 'No pagado'}
                    </button>
                  </td>
                </tr>
              ))}
              </tbody>
            </table>
          </div>
        </section>

        {/* Clasificaci√≥n */}
        <section>
          <div className="card">
            <table>
              <thead><tr><th>#</th><th>Jugador</th><th>Puntos</th><th>Balance</th></tr></thead>
              <tbody>
                {ranking.map((r,i)=>(
                  <tr key={r.id||i}>
                    <td>{i+1}</td>
                    <td>{r.nombre}</td>
                    <td><strong>{r.puntos||0}</strong></td>
                    <td>{(new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0})).format(r.balance||0)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>

        {/* Partidas / Resultados */}
        <section>
          <div className="row">
            <input type="date" value={fecha} onChange={e=>setFecha(e.target.value)} />
            <input type="number" step="1" placeholder="Buy-in (‚Ç¨)" value={buyIn} onChange={e=>setBuyIn(e.target.value)} />
            <input placeholder="Notas (opcional)" value={notas} onChange={e=>setNotas(e.target.value)} />
            <button onClick={onAddPartida}>Nueva partida</button>
          </div>

          <div className="row" style={{marginTop:10}}>
            <select id="selPartida">
              {games.map(g=> <option key={g.id} value={g.id}>{g.fecha} ¬∑ ‚Ç¨{g.buy_in}</option>)}
            </select>
            <select id="selJugador">
              {players.map(p=> <option key={p.id} value={p.id}>{p.name}</option>)}
            </select>
            <input type="number" min="1" step="1" placeholder="Posici√≥n (1=ganador)" value={posicion} onChange={e=>setPosicion(e.target.value)} />
            <input type="number" step="1" placeholder="Puntos" value={puntos} onChange={e=>setPuntos(e.target.value)} />
            <input type="number" step="1" placeholder="Premio (‚Ç¨)" value={premio} onChange={e=>setPremio(e.target.value)} />
            <button onClick={onAddResultado}>A√±adir resultado</button>
          </div>

          <div className="card" style={{marginTop:12}}>
            <table>
              <thead><tr><th>Fecha</th><th>Jugador</th><th>Posici√≥n</th><th>Puntos</th><th>Premio</th></tr></thead>
              <tbody>
                {results.map((r,i)=> (
                  <tr key={r.id||i}>
                    <td>{r.fecha || ''}</td>
                    <td>{r.jugador_nombre || ''}</td>
                    <td>{r.posicion||''}</td>
                    <td>{r.puntos||0}</td>
                    <td>{(new Intl.NumberFormat('es-ES',{style:'currency',currency:'EUR',maximumFractionDigits:0})).format(r.premio||0)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </section>
      </div>
    );
  }

  const container = document.createElement('div');
  document.querySelector('main').appendChild(container);
  const root = ReactDOM.createRoot(container);
  root.render(<App/>);
  </script>
</body>
</html>
